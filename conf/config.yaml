# conf/config.yaml

defaults:
  - _self_
timestamp: "${now:%Y%m%d_%H%M%S}"
# ================= è·¯å¾„é…ç½® (ä½¿ç”¨ç»å¯¹è·¯å¾„) =================
paths:
  # é¡¹ç›®æ ¹ç›®å½•ï¼Œæ ¹æ®ä½ çš„å®é™…æƒ…å†µä¿®æ”¹
  root: "/root/workspace/jychen/ex" 
  jsonl: "/root/workspace/jychen/ex/outputs/jsonl" 
  png: "/root/workspace/jychen/ex/outputs/png" 
  # ä¸­é—´äº§ç‰©
  cluster_output: "${paths.jsonl}/AMATH-lighteval_auto_clustered_result.jsonl"
  cluster_summary: "${paths.jsonl}/AMATH-lighteval_cluster_summary.jsonl"
  cluster_plot: "${paths.png}/AMATH-lighteval_cluster_distribution.png"
  cluster_vis: "${paths.png}/AMATH-lighteval_visualization.png"
  # è®°å¿†é¢‘æ¬¡æ–‡ä»¶ (ç”± pre.py ç”Ÿæˆ)
  freq_file: "${paths.root}/AMATH_memory_freq.jsonl"
  # ä¼˜åŒ–åçš„è®°å¿†åº“
  optimized_memory: "${paths.root}/AMATH-lighteval_optimized_memory_k50.jsonl"
  # ç»“æœç¼“å­˜ç›®å½•
  rag_cache_dir: "${paths.root}/rag_result_cache"

# ================= æ¨¡å‹é…ç½® =================
model:
  source: "sglang" # é€‰é¡¹: "huggingface", "gemini", "sglang"
  
  # HuggingFace é…ç½®
  hf_name: "Qwen/Qwen3-4B-Instruct-2507"
  device: "cuda"
  batch_size: 20
  max_input_len: 4096
  max_new_tokens: 1024
  
  # Gemini é…ç½®
  gemini_name: "gemini-2.5-flash"
  # API KEY å»ºè®®é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®: export GEMINI_API_KEY="xxx"

  # SGlang é…ç½®
  sglang_api_url: "http://127.0.0.1:30000/v1"
  sglang_model_name: "Qwen/Qwen3-4B-Instruct-2507" # éœ€è¦å’Œ SGLang æœåŠ¡å¯åŠ¨æ—¶çš„åå­—ä¸€è‡´  
  # Embedding æ¨¡å‹ (ç”¨äºèšç±»å’Œä¼˜åŒ–)
  embedding_name: "BAAI/bge-large-en-v1.5"

# ================= ä»»åŠ¡é…ç½® =================

# 1. èšç±» (Cluster) å‚æ•°
cluster:
  method: "agglomerative" # "agglomerative" or "kmeans"
  distance_threshold: 1.0
  kmeans_n_clusters: 10
  vis_method: "tsne" # "tsne", "pca", "umap"
  enable_pca_preprocess: True
  pca_preprocess_dims: 50
  tsne_perplexity: 40

# 2. é¢„å¤„ç†ä¸è¯„ä¼° (Pre & Eval) å‚æ•°
experiment:
  mode: "rag" # "baseline", "rag", "all"
  dataset_name: "DigitalLearningGmbH/MATH-lighteval"
  dataset_config: "algebra"
  debug_num: null # è®¾ç½®ä¸º null è·‘å…¨é‡ï¼Œæ•°å­—ç”¨äºè°ƒè¯•
  visualize_memory: True
  #å­—æ®µæ˜ å°„é…ç½®
  field_map:
    question: "problem"   # æ•°æ®é›†ä¸­ä»£è¡¨â€œé—®é¢˜â€çš„åˆ—å
    answer: "solution"    # æ•°æ®é›†ä¸­ä»£è¡¨â€œç­”æ¡ˆâ€çš„åˆ—å  
  # FlashRAG æ£€ç´¢å‚æ•°
  retrieval_topk: 3
  retrieval_method: "bm25"

  prompts:
      rag_system: |
        You are a math expert. You can solve math problems in one second to give the correct answer. Below are some similar solved problems. Refer to the logic in these examples to solve the new question.

        Solve the problem in a very brief. Don't answer more than 80 tokens. If the problem is easy, You can also just give the final answer. Do not perform unit conversion.
        Try to use fractions instead of decimals.
        âš ï¸ IMPORTANT: You MUST put the final answer within \boxed{{}}. For example: \boxed{{10}} or \boxed{{x \in [-1,1]}}.

        {reference}

        ### Question:
        {question}

        ### Answer:
        Let's think step by step.

# 3. ä¼˜åŒ–å™¨ (Optimizer) å‚æ•°
optimizer:
  top_k_high: 30         # é«˜é¢‘ Anchor æ•°é‡
  bottom_k_low: 30       # ä½é¢‘ å€™é€‰æ•°é‡
  low_freq_threshold: 1  # åªæœ‰ freq < 1 ä¸”è¢«åˆå¹¶æ—¶æ‰åˆ é™¤
  top_n_similar: 5       # ç±»å†…åˆå¹¶ Top-N
  llm_batch_size: 8      # æ‰¹é‡æ‰©å†™å¤§å°
  # ğŸ”¥ä¼˜åŒ–å™¨ä¸“ç”¨çš„ Prompts
  prompts:
    summarize_high_freq: |
      ä½ æ˜¯æ•°å­¦åŠ©æ•™ã€‚ä¸‹é¢æ˜¯ä¸€ç»„å±äºåŒä¸€é¢˜å‹çš„è®°å¿†æ¡ç›®ï¼Œå®ƒä»¬éƒ½æ¥è‡ªåŒä¸€ä¸ªèšç±»ï¼ˆåŒç±»é—®é¢˜ï¼‰ã€‚
      è¯·å°†å®ƒä»¬åˆå¹¶æˆ**ä¸€æ¡æ›´å®Œæ•´ã€æ›´æŠ½è±¡çš„è®°å¿†**ï¼Œè¦æ±‚ï¼š

      1. ä¸æ”¹å˜ä»»ä½•ç»“è®ºï¼Œä¹Ÿä¸è¦å¼•å…¥æ–°çš„æ•°å€¼æˆ–é¢å¤–äº‹å®ã€‚
      2. ä¿ç•™æ‰€æœ‰å…³é”®æ¡ä»¶ã€å…¬å¼ä¸è§£é¢˜ç»“è®ºã€‚
      3. é€‚å½“æ€»ç»“å…±åŒçš„è§£é¢˜æ€è·¯ï¼Œå¯ä»¥åˆå¹¶é‡å¤ä¿¡æ¯ã€‚
      4. ç”¨Englishå†™æˆä¸€æ®µæˆ–ä¸¤æ®µè¿ç»­æ–‡æœ¬ï¼Œä¸è¦åˆ†æ¡åˆ—å‡ºåŸé¢˜å·ã€‚
      âš ï¸ IMPORTANT: You MUST put the final answer within \boxed{{}}. For example: \boxed{{10}} or \boxed{{x+1}}.
      å¾…åˆå¹¶çš„è®°å¿†æ¡ç›®å¦‚ä¸‹ï¼š
      {items_formatted}

    expand_low_freq: |
      ä½ æ˜¯æ•°å­¦åŠ©æ•™ã€‚ä¸‹é¢æ˜¯ä¸€æ¡æ•°å­¦é¢˜ç›®çš„è®°å¿†å†…å®¹ã€‚

      è¯·åœ¨ **ä¸æ”¹å˜é¢˜ç›®æ¡ä»¶å’Œç­”æ¡ˆã€ä¸æ·»åŠ ä»»ä½•æ–°æ•°å€¼æˆ–äº‹å®** çš„å‰æä¸‹ï¼Œå¯¹å®ƒè¿›è¡Œè¯­ä¹‰æ‰©å†™ï¼š
      1. å¯ä»¥å¢åŠ å¯¹é¢˜ç›®è€ƒå¯Ÿç‚¹çš„è§£é‡Šå’ŒèƒŒæ™¯è¯´æ˜ã€‚
      2. å¯ä»¥åŠ å…¥åŒä¹‰æ”¹å†™ã€æ›´å¤šè‡ªç„¶è¯­è¨€è¡¨è¿°ï¼Œä»¥ä¾¿æœªæ¥æ›´å®¹æ˜“è¢«æ£€ç´¢åˆ°ã€‚
      3. è¾“å‡ºä¸€æ®µæˆ–ä¸¤æ®µEnglishæ–‡æœ¬ï¼Œä¸è¦ä¸¢å¤±åŸå§‹ä¿¡æ¯ã€‚
      âš ï¸ IMPORTANT: You MUST put the final answer within \boxed{{}}. For example: \boxed{{10}} or \boxed{{x+1}}.
      åŸå§‹è®°å¿†ï¼š
      {text}