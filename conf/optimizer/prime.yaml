# conf/optimizer/prime.yaml

top_k_high: 64
bottom_k_low: 64
top_k_evolve: 64
low_freq_threshold: 1
top_n_similar: 5
llm_batch_size: 64

max_memory_len: 8192

prune:
  enabled: true
  verbose: true
  z: 1.64                 # ~90% one-sided
  min_cluster_size: 2
  skip_negative_cluster: true
  min_obs_best: 6
  best_lcb_thr: 0.70
  trash_ucb_thr: 0.35
  max_prune_per_cluster: 3
prompts:
    expand_low_freq: |
      You are an expert Math Olympiad Coach.
      [Goal]:
      this memory can't help our model to solve problems, transform it into a high-quality problem-solving guide.
      the memory is :
      {text}
      There are some high-quality memories from similar problems:
      {good_examples}
      Don't write too much and you'd better keep the key word of this question.
      ⚠️ Output Format:
      Question: ...
      Answer: ...

    xxxxx: |
      You are a xxxx
      Please comnine the following items
      MEMORY1_BEGIN
      {memory_1}
      MEMORY1_END
      ...
      
    textgrad_correction: |
      You are optimizing a memory entry for a RAG system.
      
      [Original Memory]
      {content}
      
      [Critique / Gradient]
      This memory was INCORRECTLY retrieved for the following queries:
      {neg_text}
      
      [Positive Guidance]
      Successful neighboring memories:
      {good_examples}
      
      [Task]
      Rewrite the memory content to be more SPECIFIC and avoid the errors above.
      Output ONLY the rewritten content.

    apply_gradient: |
      You are a Knowledge Editor for a RAG system.
      Your task is to rewrite the memory based on the Expert's critique.

      [Original Memory]
      {content}

      [Expert's Critique]
      {gradient}
      {momentum_part}

      [Constraints]
      1. **NO Meta-data**: Do NOT include fields like "Domain:", "Problem Type:", "Reasoning Path:", "Cluster:", "Note:", etc.
      2. **NO Fluff**: Do NOT write introductions like "This memory helps with..." or "Here is the rewritten memory".
      3. **Direct Content**: Start directly with the core knowledge (Formulas, Theorems, Key Steps, or Python Code).
      4. **Latex Format**: Use standard latex for math.

      [Goal]
      Produce a clean, dense, and "ready-to-retrieve" knowledge snippet.

    gradient_generate: |
      You are a Senior Knowledge Engineer diagnosing a RAG system memory.
      [Target Memory]
      {content}

      [Failure Cases]
      The system used this memory to answer the following queries but failed:
      {neg_text}

      [Task: Calculate Gradient]
      Analyze WHY this memory failed.
      - Is it missing specific formulas or conditions?
      - Is it ambiguous?
      - Is it a "Hubness" problem (irrelevant but high similarity)?

      Provide a concise **Improvement Instruction** (The Gradient).
      Start with "To fix this, you should..."


    gradient_reconstruct: |
      You are a Knowledge Architect.
      Here are {k} queries that triggered a retrieval failure:
      {neg_queries}
      
      [Task]
      Identify the MISSING KNOWLEDGE or COMMON MISCONCEPTION across these queries.
      Don't analyze them one by one. Summarize the core concept that is needed to answer them all.
      
      Output a concise instruction (The Gradient) for a writer to create a new memory entry.
      Start with: "Create a memory that explains..."

    
    
    # 低分记忆处理区（优化版：更稳健的解析、更少幻觉、更强可复现性）

    low_grad_expert: |
      You are a Senior Memory Auditor for a Retrieval-Augmented Generation (RAG) system.

      [Target Memory]
      {content}

      [Failed Queries]
      These queries retrieved the Target Memory but the final answers were judged incorrect:
      {neg_queries}

      [Your Job]
      Act as an Expert Cognitive Analyst. Diagnose why the current memory fails to support the logic required for these queries. Your goal is to enhance the **generalization capability** of the memory bank by identifying missing reasoning frameworks, methodologies, or mental models, rather than simply filling in factual answers.

      Choose ONE of the following actions:

      - REFINE: The memory covers the topic but lacks depth in **reasoning logic** or **methodology**. Update it to include the "how-to" or underlying principles.
      - EXPAND: The memory implies a broader concept but misses a specific **problem-solving paradigm** required by the failed queries. Keep the old memory and create a new, abstract memory for this missing logic/strategy.
      - REPLACE: The memory is fundamentally misleading or focuses on irrelevant rote facts. Discard it and write a new memory focused on the **core analytical framework** needed for such queries.

      [Grounding Rules]
      - **Focus on Logic over Fact:** Do not just add the correct answer. Instead, extract the *generic algorithm*, *inference pattern*, or *step-by-step methodology* used to derive the answer.
      - **Generalization:** The advice must be applicable to a class of similar problems, not just the specific failed queries.
      - **Avoid Rote Memorization:** Refrain from directly incorporating specific solutions unless they serve as a canonical example for a rule.
      - **Evidence:** Base your analysis on the gap between the *current memory's scope* and the *reasoning depth* required by the failed queries.
      - Do NOT include any meta-commentary or apologies.

      [Output Format — STRICT]
      Output EXACTLY the following three lines (no extra text):

      Analysis: \box{{<Identify the missing **cognitive capability** or **reasoning path** (e.g., "Lacks the derivation logic for X", "Missing the criteria to distinguish A from B"). 1 sentence.>}}
      Advice: \advice{{<Actionable instructions focusing on **methodology**. Include: (i) abstract principles or logic chains to add; (ii) 3–8 retrieval keywords emphasizing concepts/methods; (iii) if EXPAND/REPLACE, define the scope of the NEW **strategic memory**. Keep <=180 words.>}}
      Action: \box{{REFINE|EXPAND|REPLACE}}

      You can think step by step.

    appgrad_low_refine: |
      You are a Cognitive Knowledge Engineer for a RAG system.

      [Original Memory]
      {content}

      [Expert Advice]
      {gradient}

      [Task]
      Rewrite the memory to internalize the **reasoning logic** and **methodology** highlighted in the Expert Advice.
      - **Generalize:** Transform the specific error diagnosis into a universal rule, framework, or step-by-step thinking process applicable to similar future problems.
      - **Methodology over Fact:** Prioritize explaining *how* to arrive at the solution (derivation, analysis steps) rather than just stating the final fact/answer.
      - **Atomic:** Focus on ONE core logic chain or concept.
      - **Retrieval-friendly:** Include 3–8 keywords (as a short "Keywords:" line) focusing on concepts and methods (e.g., "Chain of Thought", "Principle of X") rather than just specific entities.

      [Hard Constraints]
      - Do NOT simply append the correct answer to the failed query. Use the query only as an example to illustrate the logic.
      - If the advice implies a procedure, outline it clearly (e.g., "Step 1:...", "Principle:...").
      - Do NOT invent uncertain facts.
      - Output ONE memory only.
      - Output NOTHING except the memory wrapper.

      [Output Format — STRICT]
      \memory{{<rewritten memory containing the logic/framework>}}

    appgrad_low_replace: |
      You are a Cognitive Knowledge Creator for a RAG system.

      [Failed Queries]
      {neg_queries}

      [Expert Advice]
      {gradient}

      [Task]
      Create ONE brand-new, atomic memory entry that establishes the **missing reasoning framework** or **mental model** identified in the Expert Advice.
      
      [Guidelines]
      - **Abstract the Logic:** Do not merely answer the failed queries. Instead, extract the underlying **principle, algorithm, or methodology** required to solve such problems.
      - **Generalization:** Write for a general class of problems. Treat the {neg_queries} as specific *instances* or *examples* to illustrate the rule, not the sole focus.
      - **Structure:** Ideally, define the concept first, then outline the logical steps/procedure to apply it.
      - **Retrieval-friendly:** Add a "Keywords:" line with 3–10 keywords. Include **functional keywords** (e.g., "Analysis", "Calculation Method", "Evaluation Criteria") alongside topic keywords.
      - **Certainty:** Only include high-confidence methodologies.

      [Hard Constraints]
      - Output ONE memory only.
      - Output NOTHING except the memory wrapper.

      [Output Format — STRICT]
      \memory{{<new memory focusing on logic/methodology>}}


    # 高分记忆处理区

    high_grad_expert: |
      You are a Senior Cognitive Architect optimizing a 'Champion' memory entry.
      This memory is a strong baseline (high success rate) but fails on specific queries due to limited scope or depth.

      [Champion Memory]
      {content}

      [Failed Queries]
      {neg_queries}

      [Task]
      Analyze why the Champion Memory's logic failed to cover these queries. Determine the expansion strategy:

      - IGNORE: The failure is unrelated (noise, out of scope, or user error).
      - SUPPLEMENT: The query belongs to the **same logical framework** but requires a specific **exception handling** or **nuance**. (e.g., "The rule applies, but with condition X"). The new memory will be a lightweight "patch" or "addendum".
      - SPLIT: The query represents a **distinct sub-domain** or a **complex scenario** that requires its own dedicated **reasoning methodology**. (e.g., "The general rule is insufficient; use this specific algorithm instead"). The new memory will be a standalone "Specialized Logic".

      [Output Format]
      Provide brief reasoning (1-3 sentences) focusing on the *logical gap*, then output ONE command line:

      - If IGNORE:
        Reasoning: ...
        Command: \box{{IGNORE}} \gradient{{None}}

      - If SUPPLEMENT:
        Reasoning: ...
        Command: \box{{SUPPLEMENT}} \gradient{{<Instructions to define the **exception logic** or **boundary condition**. E.g., "Define the constraint that prevents the general rule from working here.">}}

      - If SPLIT:
        Reasoning: ...
        Command: \box{{SPLIT}} \gradient{{<Instructions to abstract a **new specialized methodology** for this sub-topic. E.g., "Create a standalone framework specifically for analyzing [Scenario X].">}}

    appgrad_high_supplement: |
      You are a Cognitive Knowledge Integrator.
      We have a "Champion Memory" (high reliability) that needs to be expanded to cover specific edge cases or complex scenarios.

      [Existing Memory]
      {original_content}

      [Expert Advice]
      {advice}

      [Task]
      Create a **Unified Memory Entry** that preserves the original knowledge while appending the new reasoning logic.
      
      [Guidelines]
      1. **Preserve the Core:** Retain the valid information from the [Existing Memory] as the foundation. You may lightly format it for clarity but do not remove key facts.
      2. **Append the Logic:** Add a distinct section (e.g., "Boundary Analysis", "Exception Handling", or "Advanced Methodology") derived from the [Expert Advice].
      3. **Focus on Reasoning:** The added section must explain the **logical bridge** or **decision criteria** for the edge case, not just a factual patch.
      4. **Keywords:** Update the keywords to cover both the general concept and the specific edge case.

      [Output Format — STRICT]
      Output ONLY one block wrapped in \memory{{...}}.
      \memory{{
      <Original content (refined)>
      <The new methodology/reasoning for the edge case>
      }}

    appgrad_high_split: |
      You are a Specialized Knowledge Architect.
      The Expert has identified that the missed queries belong to a **distinct sub-topic** or **complex scenario** requiring a dedicated memory entry.

      [Missed Queries]
      {neg_text}

      [Expert Advice]
      {advice}

      [Task]
      Formulate a standalone **"Specialized Logic"** memory entry.
      Your goal is to abstract the specific solution to the missed queries into a **reusable methodology** or **concept definition** for this specific sub-domain.

      [Guidelines]
      1. **Methodology over Instance:** Do not simply record the answer to the missed query. Instead, record the **algorithm, decision tree, or theoretical framework** needed to derive that answer.
      2. **Define the Scope:** Clearly state *when* this specialized logic applies (e.g., "In high-concurrency environments...", "When the limit approaches zero...").
      3. **Self-Contained:** The memory must provide enough context to be understood without referencing the parent memory.
      4. **Generalization:** Ensure the logic is broad enough to handle variations of the failed queries.

      [Format Requirement]
      Output ONLY one block wrapped in \memory{{...}}.
      The content should ideally follow a structure: [Scenario Definition] -> [Reasoning Logic/Methodology] -> [Key Constraints].

      [Strict Output]
      \memory{{<New specialized memory content>}}

